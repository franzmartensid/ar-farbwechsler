<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>AR: Farben â€¢ Texturen â€¢ Bewegen â€¢ Skalieren â€¢ Licht â€¢ Schrauben</title>
<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { margin: 0; overflow: hidden; }

  /* Start-Knopf oben */
  #instructions {
    position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
    color: #fff; background: rgba(0,0,0,.7);
    padding: 12px 20px; border-radius: 10px; font-family: sans-serif;
    z-index: 9999; cursor: pointer; font-size: 1.1em; text-align: center;
  }

  /* Button-Gruppen links/rechts, einheitliche Button-Breite */
  .button-group {
    position: absolute; top: 60px; display: flex; flex-direction: column;
    gap: 4px; z-index: 1000;
  }
  .button-group.left { left: 10px; }
  .button-group.right { right: 10px; }

  .button-group button {
    width: 80px; flex: 0 0 auto; text-align: center;
    padding: 8px 12px; border-radius: 5px; border: none;
    cursor: pointer; font-weight: bold; color: white; font-size: 0.8em;
  }

  .color-button   { background: gray; }
  .rotate-button  { background: black; }
  .move-button    { background: teal; }
  .scale-button   { background: purple; }
  .texture-button { background: brown; }
  .light-button   { background: orange; }
  .screw-button   { background: #c2185b; }

  /* Tap-Feedback */
  button.flash { animation: flash 0.2s ease; }
  @keyframes flash {
    0% { transform: scale(1); box-shadow: 0 0 3px white; }
    50%{ transform: scale(1.1); box-shadow: 0 0 15px white; }
    100%{ transform: scale(1); box-shadow: 0 0 3px white; }
  }
</style>
</head>
<body>

<!-- Start -->
<div id="instructions">Tippe hier, um die Kamera zu aktivieren und AR zu starten</div>

<!-- Linke Buttons -->
<div class="button-group left">
  <!-- Farben -->
  <button class="color-button"  style="background:#ff0000" data-color="#ff0000">Rot</button>
  <button class="color-button"  style="background:#00ff00" data-color="#00ff00">GrÃ¼n</button>
  <button class="color-button"  style="background:#0000ff" data-color="#0000ff">Blau</button>
  <!-- Texturen -->
  <button class="texture-button" data-texture="wood">ğŸŒ³ Holz</button>
  <button class="texture-button" data-texture="metal">âš™ï¸ Metall</button>
  <button class="texture-button" data-texture="stone">ğŸª¨ Stein</button>
</div>

<!-- Rechte Buttons -->
<div class="button-group right">
  <!-- Rotation -->
  <button class="rotate-button" data-rotate="15">âŸ³ Rechts</button>
  <button class="rotate-button" data-rotate="-15">âŸ² Links</button>
  <!-- Verschieben -->
  <button class="move-button" data-move="forward">â†‘ Vor</button>
  <button class="move-button" data-move="backward">â†“ ZurÃ¼ck</button>
  <button class="move-button" data-move="left">â† Links</button>
  <button class="move-button" data-move="right">â†’ Rechts</button>
  <!-- Skalierung -->
  <button class="scale-button" data-scale="up">â• GrÃ¶ÃŸer</button>
  <button class="scale-button" data-scale="down">â– Kleiner</button>
  <!-- Helligkeit (emissive) -->
  <button class="light-button" data-action="increase">ğŸ’¡ Heller</button>
  <button class="light-button" data-action="decrease">ğŸ’¡ Dunkler</button>
  <!-- Directional-Licht links/rechts -->
  <button class="light-button" id="toggle-directional">ğŸ’¡ Licht L/R</button>
  <!-- Schrauben -->
  <button class="screw-button" id="btn-s1">ğŸ”© Schraube 1</button>
  <button class="screw-button" id="btn-s2">ğŸ”© Schraube 2</button>
</div>

<a-scene id="ar-scene" embedded vr-mode-ui="enabled:false" style="display:none"
         arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

  <!-- Assets: Schraubenmodell EINMAL laden -->
  <a-assets>
    <a-asset-item id="screwModel" src="https://franzmartensid.github.io/Franz-Fridolin/m6x16.glb"></a-asset-item>
  </a-assets>

  <!-- Marker -->
  <a-marker preset="hiro" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">

    <!-- Hauptmodell -->
    <a-entity id="model"
      gltf-model="url(https://franzmartensid.github.io/Franz-Fridolin/board-handle.gltf)"
      scale="0.005 0.005 0.005"
      rotation="0 0 0"
      position="0 0.1 0">
    </a-entity>

    <!-- Lichter -->
    <a-entity light="type: ambient; color: #ffffff; intensity: 0.5"></a-entity>
    <a-light id="dirLight" type="directional" position="3 3 1.5" intensity="1.5"></a-light>

    <!-- SCHRAUBE 1 (Instanz A) -->
    <a-entity id="screw1"
      gltf-model="#screwModel"
      position="0.445 0.7 -0.26"
      rotation="180 0 0"
      scale="0.007 0.007 0.007"
      animation__spin="property: rotation; startEvents: go; to: 180 -1080 0; dur: 1400; easing: linear"
      animation__drive="property: position; startEvents: go; to: 0.445 0.15 -0.26; dur: 1400; easing: easeInOutQuad">
      <!-- Eindrehen: Rot + reinfahren; Start per Event 's1-go' -->
      
    </a-entity>

    <!-- SCHRAUBE 2 (Instanz B) -->
    <a-entity id="screw2"
      gltf-model="#screwModel"
      position="-0.445 0.7 -0.26"
      rotation="180 0 0"
      scale="0.007 0.007 0.007"
      animation__spin="property: rotation; startEvents: go; to: 180 -1080 0; dur: 1400; easing: linear"
      animation__drive="property: position; startEvents: go; to: -0.445 0.15 -0.26; dur: 1400; easing: easeInOutQuad">
    </a-entity>

  </a-marker>

  <a-entity camera></a-entity>
</a-scene>

<script>
// Kamera starten
const instructions = document.getElementById('instructions');
const arScene = document.getElementById('ar-scene');
instructions.addEventListener('click', () => {
  instructions.style.display = 'none';
  arScene.style.display = 'block';
});

// Hauptmodell
const model = document.querySelector('#model');

// ------------------ FARBE ------------------
document.querySelectorAll('.color-button').forEach(btn => {
  btn.addEventListener('click', () => {
    const color = btn.getAttribute('data-color');
    model.object3D.traverse(n => { if(n.isMesh && n.material){ n.material.color.set(color); } });
  });
});

// ------------------ ROTATION ------------------
document.querySelectorAll('.rotate-button').forEach(btn => {
  btn.addEventListener('click', () => {
    const angle = parseFloat(btn.getAttribute('data-rotate'));
    const r = model.getAttribute('rotation');
    model.setAttribute('rotation', { x: r.x, y: r.y + angle, z: r.z });
  });
});

// ------------------ VERSCHIEBEN ------------------
const moveDistance = 0.9;
document.querySelectorAll('.move-button').forEach(btn => {
  btn.addEventListener('click', () => {
    const dir = btn.getAttribute('data-move');
    const p = model.getAttribute('position');
    const np = { ...p };
    if(dir==='forward')  np.z -= moveDistance;
    if(dir==='backward') np.z += moveDistance;
    if(dir==='left')     np.x -= moveDistance;
    if(dir==='right')    np.x += moveDistance;
    model.setAttribute('position', np);
  });
});

// ------------------ SKALIERUNG ------------------
const scaleStep = 0.2;
document.querySelectorAll('.scale-button').forEach(btn => {
  btn.addEventListener('click', () => {
    const s = model.getAttribute('scale');
    const up = btn.getAttribute('data-scale')==='up';
    const f = up ? (1+scaleStep) : (1-scaleStep);
    model.setAttribute('scale', { x: s.x*f, y: s.y*f, z: s.z*f });
  });
});

// ------------------ TEXTUREN ------------------
const textureBaseURL = "https://franzmartensid.github.io/Franz-Fridolin/";
document.querySelectorAll('.texture-button').forEach(btn => {
  btn.addEventListener('click', () => {
    const type = btn.getAttribute('data-texture');
    let url = '';
    if(type==='wood')  url = textureBaseURL + 'oak_veneer_01_diff_4k.jpg';
    if(type==='metal') url = textureBaseURL + 'rusty_metal_04_diff_4k.jpg';
    if(type==='stone') url = textureBaseURL + 'rock_face_03_diff_4k.jpg';

    const loader = new THREE.TextureLoader();
    loader.load(url, tex => {
      tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
      tex.repeat.set(1,1);
      model.object3D.traverse(n => {
        if(n.isMesh){
          n.material = new THREE.MeshStandardMaterial({
            map: tex, metalness: 0.3, roughness: 0.6, emissive: new THREE.Color(0x000000)
          });
          n.material.needsUpdate = true;
        }
      });
    });
  });
});

// ------------------ HELLLIGKEIT (EMISSIVE) ------------------
const lightStep = 0.1;
document.querySelectorAll('.light-button').forEach(btn => {
  btn.addEventListener('click', () => {
    const action = btn.getAttribute('data-action');
    if(!action) return;
    model.object3D.traverse(n => {
      if(n.isMesh && n.material){
        if(!n.material.emissive) n.material.emissive = new THREE.Color(0x000000);
        let hsl = {}; n.material.emissive.getHSL(hsl);
        hsl.l += (action==='increase' ? lightStep : -lightStep);
        hsl.l = Math.min(1, Math.max(0, hsl.l));
        n.material.emissive.setHSL(hsl.h, hsl.s, hsl.l);
        n.material.needsUpdate = true;
      }
    });
  });
});

// ------------------ LICHT LINKS / RECHTS ------------------
const directionalLight = document.getElementById('dirLight');
let lightToggle = false;
document.getElementById('toggle-directional').addEventListener('click', () => {
  lightToggle = !lightToggle;
  directionalLight.setAttribute('position', lightToggle ? '-3 3 1.5' : '3 3 1.5');
});

// ------------------ SCHRAUBEN ------------------

// rot aufleuchten
function setEmissive(entity, colorHex){
  entity.object3D.traverse(n=>{
    if(n.isMesh){
      if(!n.material) return;
      if(!n.material.emissive) n.material.emissive = new THREE.Color(0x000000);
      n.material.emissive.setHex(colorHex);
      n.material.needsUpdate = true;
    }
  });
}

// einschrauben starten (drehen + runter bewegen)
function runScrew(entityId){
  const e = document.getElementById(entityId);
  setEmissive(e, 0xff0000); // rot
  e.emit('go');             // Animation starten
  setTimeout(()=> setEmissive(e, 0x000000), 1400);
}

// Buttons Schrauben
document.getElementById('btn-s1').addEventListener('click', () => runScrew('screw1'));
document.getElementById('btn-s2').addEventListener('click', () => runScrew('screw2'));

// Tasten-Animation
document.querySelectorAll('button').forEach(b=>{
  b.addEventListener('click', ()=>{ b.classList.add('flash'); setTimeout(()=>b.classList.remove('flash'),200); });
});
</script>

</body>
</html>
